<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Task List (Auto-Reset Each Week)</title>
  <style>
    :root {--primary: #333;--accent: #ffb900;--text: #4a4a4a;--bg: #f5f5f5;}
    *, *::before, *::after {box-sizing: border-box;}
    body {margin: 0;padding: 2rem;font-family: 'Segoe UI', Tahoma, sans-serif;background: var(--bg);color: var(--text);}
    h2 {margin-top: 0;margin-bottom: 1rem;font-size: 1.5rem;color: var(--primary);border-bottom: 2px solid var(--accent);padding-bottom: 0.25rem;}
    form#filterForm {display: flex;flex-wrap: wrap;gap: 0.75rem;align-items: center;margin-bottom: 1.5rem;}
    form#filterForm select {padding: 0.5rem 0.75rem;border: 1px solid #ccc;border-radius: 4px;background: #fff;color: var(--text);font-size: 1rem;height: 2.25rem;cursor: pointer;}
    form#filterForm select#staffSelect {width: 220px;}
    form#filterForm select#taskDay {width: 150px;}
    .hidden { display: none; }
    #overallProgressContainer {margin-bottom: 1.5rem;}
    #overallProgressContainer > .label-bar {display: flex;align-items: center;justify-content: space-between;font-weight: 600;color: var(--primary);margin-bottom: 0.25rem;}
    #overallProgressContainer .progress-track {width: 100%;height: 8px;background: #e0e0e0;border-radius: 4px;overflow: hidden;}
    #overallProgressBar {width: 0%;height: 100%;background: var(--accent);transition: width 0.3s ease;}
    table#taskTable {width: 100%;border-collapse: collapse;margin-top: 0.5rem;font-size: 0.95rem;}
    table#taskTable thead {background: #fafafa;}
    table#taskTable th, table#taskTable td {border: 1px solid #ddd;padding: 0.5rem 0.75rem;text-align: left;}
    table#taskTable th {font-weight: 600;color: var(--primary);}
    table#taskTable tr:nth-child(even) {background: #fcfcfc;}
    table#taskTable td.center,
    table#taskTable th.center {text-align: center;}
  </style>
</head>

<body>
  <h2>Task List</h2>
  <form id="filterForm">
    <select id="staffSelect" required>
      <option value="" disabled>Loading options…</option>
    </select>

    <select id="taskDay" required>
      <option value="" disabled selected>Select Day</option>
    </select>
  </form>

  <div id="overallProgressContainer">
    <div class="label-bar">
      <span>Progress:</span>
      <span id="overallProgressText">0%</span>
    </div>
    <div class="progress-track">
      <div id="overallProgressBar"></div>
    </div>
  </div>

  <table id="taskTable">
    <thead>
    </thead>
    <tbody>
    </tbody>
  </table>

  <script>
    const SHEET_ID = '1uqcBvF391zu34vQY-orpiWpGqqcjqevtB3yFByd0VDI';
    const staffNames = [
      'Mary',
      'Shari',
      'Hanna',
      'Jeh',
      'Daryl',
      'Hyacinth',
      'Marcus',
      'Jovilyn',
      'Daricalyn',
      'Chez',
      'Christine',
      'Kath'
    ];

    const staffOptions = ['Summary of Schedule', ...staffNames];

    const STORAGE_KEY_DONE = 'kp360_done_states';
    const STORAGE_KEY_LAST_RESET = 'kp360_last_reset';

    let doneStates = {};
    let currentRawRows = [];
    let currentHeaders = [];
    let timeKey = null;
    let dayColumnKeys = [];

    function resetIfPastSundayMidnightEST() {
      const now = new Date();
      const fmtParts = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/New_York',
        hour12: false,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        weekday: 'long'
      }).formatToParts(now);

      let y, M, d, H, m, s, wdayName;
      fmtParts.forEach(p => {
        if (p.type === 'year')        y = p.value;
        else if (p.type === 'month')   M = p.value;
        else if (p.type === 'day')     d = p.value;
        else if (p.type === 'hour')    H = p.value;
        else if (p.type === 'minute')  m = p.value;
        else if (p.type === 'second')  s = p.value;
        else if (p.type === 'weekday') wdayName = p.value;
      });

      const weekdayIndex = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']
                            .indexOf(wdayName);

      const tzName = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/New_York',
        timeZoneName: 'short'
      }).formatToParts(now).find(p => p.type === 'timeZoneName').value;
      
      const offsetHours = (tzName === 'EDT') ? 4 : 5;
      const estNowAsUTC = new Date(Date.UTC(
        Number(y),
        Number(M) - 1,
        Number(d),
        Number(H) + offsetHours,
        Number(m),
        Number(s)
      ));

      const localDay = Number(d);
      const sundayESTDay = localDay - weekdayIndex; 
      const sundayESTYear  = Number(y);
      const sundayESTMonth = Number(M) - 1;
      const sundayESTDate  = sundayESTDay;

      const sundayMidnightEST_asUTC = new Date(Date.UTC(
        sundayESTYear,
        sundayESTMonth,
        sundayESTDate,
        offsetHours,
        0,
        0
      ));

      const stored = localStorage.getItem(STORAGE_KEY_LAST_RESET);
      if (!stored) {
        localStorage.removeItem(STORAGE_KEY_DONE);
        localStorage.setItem(STORAGE_KEY_LAST_RESET, sundayMidnightEST_asUTC.toISOString());
        doneStates = {};
        return;
      }

      const lastResetDate = new Date(stored);
      if (sundayMidnightEST_asUTC.getTime() > lastResetDate.getTime()) {
        localStorage.removeItem(STORAGE_KEY_DONE);
        localStorage.setItem(STORAGE_KEY_LAST_RESET, sundayMidnightEST_asUTC.toISOString());
        doneStates = {};
      }
    }

    function loadDoneStates() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_DONE);
        doneStates = raw ? JSON.parse(raw) : {};
      } catch {
        doneStates = {};
      }
    }

    function saveDoneStates() {
      try {
        localStorage.setItem(STORAGE_KEY_DONE, JSON.stringify(doneStates));
      } catch (e) {
        console.error('Failed to save doneStates:', e);
      }
    }

    function buildSheetURLForTab(tabName) {
      const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
      const query = encodeURIComponent('SELECT *');
      return `${base}?sheet=${encodeURIComponent(tabName)}&tq=${query}`;
    }

    function to12Hour(rawTime) {
      if (!rawTime) return '';
      let sep = null;
      if (rawTime.includes('–')) sep = '–';
      else if (rawTime.includes('-')) sep = '-';
      if (sep) {
        const [from, to] = rawTime.split(sep).map(s => s.trim());
        return formatSingle(from) + '–' + formatSingle(to);
      }
      return formatSingle(rawTime.trim());
    }
    function formatSingle(hhmm) {
      const [hStr, mStr] = hhmm.split(':');
      if (hStr == null || mStr == null) return hhmm;
      let hh = parseInt(hStr, 10);
      const mm = parseInt(mStr, 10);
      const suffix = hh >= 12 ? 'PM' : 'AM';
      hh = hh % 12;
      if (hh === 0) hh = 12;
      return hh + ':' + String(mm).padStart(2, '0') + ' ' + suffix;
    }

    function computeTaskKey(tabName, day, time, taskDesc) {
      return `${tabName.trim()}||${day.trim()}||${time.trim()}||${taskDesc.trim()}`.toLowerCase();
    }

    function clearTable() {
      document.querySelector('#taskTable thead').innerHTML = '';
      document.querySelector('#taskTable tbody').innerHTML = '';
    }

    function renderSummaryTable() {
      const thead = document.querySelector('#taskTable thead');
      const tbody = document.querySelector('#taskTable tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      if (!currentHeaders.length) return;

      const headerRow = document.createElement('tr');
      currentHeaders.forEach(hdr => {
        const th = document.createElement('th');
        th.textContent = hdr;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      currentRawRows.forEach(rowObj => {
        const tr = document.createElement('tr');
        currentHeaders.forEach(hdr => {
          const td = document.createElement('td');
          td.textContent = rowObj[hdr] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function renderTasksForStaffAndDay() {
      const staffTab  = document.getElementById('staffSelect').value;
      const chosenDay = document.getElementById('taskDay').value;
      const tbody     = document.querySelector('#taskTable tbody');
      tbody.innerHTML = '';

      if (!staffTab || !chosenDay) {
        updateOverallProgress();
        return;
      }

      let i = 0;
      while (i < currentRawRows.length) {
        const rowObj  = currentRawRows[i];
        const rawTime = (rowObj[timeKey]   || '').toString().trim();
        const rawTask = (rowObj[chosenDay] || '').toString().trim();

        if (!rawTask) {
          i++;
          continue;
        }

        if (rawTask.toUpperCase() === 'OFF') {
          const taskKey = computeTaskKey(staffTab, chosenDay, rawTime, rawTask);
          const isDone  = !!doneStates[taskKey];

          const tr = document.createElement('tr');

          const tdDay = document.createElement('td');
          tdDay.textContent = chosenDay;
          tdDay.style.padding = '0.5rem 0.75rem';
          tdDay.style.border = '1px solid #ddd';
          tr.appendChild(tdDay);

          const tdTime = document.createElement('td');
          tdTime.textContent = '';
          tdTime.style.padding = '0.5rem 0.75rem';
          tdTime.style.border = '1px solid #ddd';
          tr.appendChild(tdTime);

          const tdTask = document.createElement('td');
          tdTask.textContent = rawTask;
          tdTask.style.padding = '0.5rem 0.75rem';
          tdTask.style.border = '1px solid #ddd';
          if (isDone) tdTask.style.textDecoration = 'line-through';
          tr.appendChild(tdTask);

          const tdDone = document.createElement('td');
          tdDone.style.textAlign = 'center';
          tdDone.style.padding = '0.5rem 0.75rem';
          tdDone.style.border = '1px solid #ddd';
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = isDone;
          chk.addEventListener('change', () => {
            tdTask.style.textDecoration = chk.checked ? 'line-through' : 'none';
            doneStates[taskKey] = chk.checked;
            saveDoneStates();
            updateOverallProgress();
          });
          tdDone.appendChild(chk);
          tr.appendChild(tdDone);

          tbody.appendChild(tr);
          i++;
          continue;
        }

        let endIndex = i;
        while (endIndex + 1 < currentRawRows.length) {
          const nextRow  = currentRawRows[endIndex + 1];
          const nextTask = (nextRow[chosenDay] || '').toString().trim();
          if (nextTask === rawTask) {
            endIndex++;
          } else {
            break;
          }
        }

        const firstRawTime = currentRawRows[i][timeKey].trim();
        const lastRawTime  = currentRawRows[endIndex][timeKey].trim();

        let combinedRaw = '';
        const splitDash = (str) => {
          if (str.includes('–')) return str.split('–').map(s => s.trim());
          if (str.includes('-')) return str.split('-').map(s => s.trim());
          return [str, str];
        };
        const [firstStart] = splitDash(firstRawTime);
        const [, lastEnd]  = splitDash(lastRawTime);
        combinedRaw = `${firstStart}-${lastEnd}`;

        const displayTime = to12Hour(combinedRaw);
        const taskText    = rawTask;
        const taskKey     = computeTaskKey(staffTab, chosenDay, firstRawTime, taskText);
        const isDone      = !!doneStates[taskKey];

        const tr = document.createElement('tr');

        const tdDay = document.createElement('td');
        tdDay.textContent = chosenDay;
        tdDay.style.padding = '0.5rem 0.75rem';
        tdDay.style.border = '1px solid #ddd';
        tr.appendChild(tdDay);

        const tdTime = document.createElement('td');
        tdTime.textContent = displayTime;
        tdTime.style.padding = '0.5rem 0.75rem';
        tdTime.style.border = '1px solid #ddd';
        tr.appendChild(tdTime);

        const tdTask = document.createElement('td');
        tdTask.textContent = taskText;
        tdTask.style.padding = '0.5rem 0.75rem';
        tdTask.style.border = '1px solid #ddd';
        if (isDone) tdTask.style.textDecoration = 'line-through';
        tr.appendChild(tdTask);

        const tdDone = document.createElement('td');
        tdDone.style.textAlign = 'center';
        tdDone.style.padding = '0.5rem 0.75rem';
        tdDone.style.border = '1px solid #ddd';
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = isDone;
        chk.addEventListener('change', () => {
          tdTask.style.textDecoration = chk.checked ? 'line-through' : 'none';
          doneStates[taskKey] = chk.checked;
          saveDoneStates();
          updateOverallProgress();
        });
        tdDone.appendChild(chk);
        tr.appendChild(tdDone);

        tbody.appendChild(tr);

        i = endIndex + 1;
      }

      updateOverallProgress();
    }

    function updateOverallProgress() {
      const tbody = document.querySelector('#taskTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const total = rows.length;
      if (total === 0) {
        document.getElementById('overallProgressText').textContent = '0%';
        document.getElementById('overallProgressBar').style.width = '0%';
        return;
      }
      let doneCount = 0;
      rows.forEach(tr => {
        const chk = tr.querySelector('input[type="checkbox"]');
        if (chk && chk.checked) doneCount++;
      });
      const pct = Math.round((doneCount / total) * 100);
      document.getElementById('overallProgressText').textContent = pct + '%';
      document.getElementById('overallProgressBar').style.width = pct + '%';
    }

    async function fetchSheetTab(tabName) {
      console.log(`Fetching data for tab: "${tabName}"`);
      try {
        const url = buildSheetURLForTab(tabName);
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const text = await resp.text();

        const jsonStr = text
          .replace(/^[^\(]*\(/, '')
          .replace(/\);?$/, '');
        const data = JSON.parse(jsonStr);
        const allRows = data.table.rows;

        if (!allRows.length) {
          console.warn(`Tab "${tabName}" has no data rows.`);
          return { rawRows: [], headers: [] };
        }

        const tableAsArrays = allRows.map(r =>
          r.c.map(cell => (cell && cell.v != null) ? cell.v.toString() : '')
        );

        const headerRow = tableAsArrays[0].map(h => h.trim());
        currentHeaders = headerRow;
        console.log(`Headers for "${tabName}":`, headerRow);

        const timeIdx = headerRow.findIndex(h => h.toLowerCase() === 'time');
        if (timeIdx >= 0) {
          timeKey = headerRow[timeIdx];
          dayColumnKeys = headerRow
            .filter((h, idx) => h !== '' && idx !== timeIdx)
            .map(h => h.toUpperCase());
        } else {
          timeKey = null;
          dayColumnKeys = [];
        }

        const rawRows = [];
        for (let i = 1; i < tableAsArrays.length; i++) {
          const cells = tableAsArrays[i];
          const obj = {};
          headerRow.forEach((hdr, colIdx) => {
            obj[hdr] = (cells[colIdx] || '').trim();
          });
          rawRows.push(obj);
        }
        console.log(`Loaded ${rawRows.length} data rows for "${tabName}".`);
        return { rawRows, headers: headerRow };

      } catch (err) {
        console.error(`Error fetching/parsing tab "${tabName}":`, err);
        return { rawRows: [], headers: [] };
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {

      resetIfPastSundayMidnightEST();
      loadDoneStates();

      const staffSelect = document.getElementById('staffSelect');
      const daySelect   = document.getElementById('taskDay');
      const progressContainer = document.getElementById('overallProgressContainer');

      staffSelect.innerHTML = '';
      staffSelect.appendChild(new Option('Select Staff', '', true, false));
      staffOptions.forEach(optName => {
        const opt = new Option(optName, optName, false, false);
        staffSelect.appendChild(opt);
      });

      staffSelect.addEventListener('change', async () => {
        const chosen = staffSelect.value;
        clearTable();

        if (chosen === 'Summary of Schedule') {
          daySelect.classList.add('hidden');
          progressContainer.classList.add('hidden');

          const { rawRows, headers } = await fetchSheetTab('Summary of Schedule');
          currentRawRows = rawRows;
          currentHeaders = headers;
          renderSummaryTable();
          return;
        }

        daySelect.classList.remove('hidden');
        progressContainer.classList.remove('hidden');

        const { rawRows, headers } = await fetchSheetTab(chosen);
        currentRawRows = rawRows;
        currentHeaders = headers;

        const timeIdx = headers.findIndex(h => h.toLowerCase() === 'time');
        timeKey = headers[timeIdx];
        dayColumnKeys = headers
          .filter((h, idx) => h !== '' && idx !== timeIdx)
          .map(h => h.toUpperCase());

        daySelect.innerHTML = '';
        daySelect.appendChild(new Option('Select Day', '', true, false));
        dayColumnKeys.forEach(d => {
          const opt = new Option(d, d, false, false);
          daySelect.appendChild(opt);
        });

        updateOverallProgress();
      });

      daySelect.addEventListener('change', () => {
        clearTable();
        const chosenStaff = staffSelect.value;
        if (chosenStaff && daySelect.value) {
          const thead = document.querySelector('#taskTable thead');
          thead.innerHTML = '';
          const headerRow = document.createElement('tr');
          ['Day','Time','Task','Done'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            if (text === 'Done') th.classList.add('center');
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          renderTasksForStaffAndDay();
        }
      });

      staffSelect.value = 'Summary of Schedule';
      staffSelect.dispatchEvent(new Event('change'));
    });
  </script>
</body>
</html>
